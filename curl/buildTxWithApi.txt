# Prepare transaction
curl https://api.testnet.iota.cafe \
--header 'content-type: application/json' \
--data '{
    "jsonrpc": "2.0",
    "id": 1,
    "method": "unsafe_payIota",
    "params": {
        "signer": "0x111111111504e9350e635d65cd38ccd2c029434c6a3a480d8947a9ba6a15b215",
        "input_coins": ["0x0031cf44d9b568dbd93302d23fa064b13b42e0c3f741783229702f85584d1ee0"],
        "recipients": ["0x111111111504e9350e635d65cd38ccd2c029434c6a3a480d8947a9ba6a15b215", "0x111111111504e9350e635d65cd38ccd2c029434c6a3a480d8947a9ba6a15b215"],
        "amounts": ["100", "200"],
        "gas_budget": "100000000"
    }
}' | jq .

# Dry run transaction
curl https://api.testnet.iota.cafe \
--header 'content-type: application/json' \
--data '{
    "jsonrpc": "2.0",
    "id": 1,
    "method": "iota_dryRunTransactionBlock",
    "params": {
        "tx_bytes": "AAADAAhkAAAAAAAAAAAIyAAAAAAAAAAAIBEREREVBOk1DmNdZc04zNLAKUNMajpIDYlHqbpqFbIVAgIAAgEAAAEBAAECAwAAAAADAAABAAECABEREREVBOk1DmNdZc04zNLAKUNMajpIDYlHqbpqFbIVAQAxz0TZtWjb2TMC0j+gZLE7QuDD90F4MilwL4VYTR7gR9SxDAAAAAAgzFKhcPCs0Q1NZdxjuD9IQkOw7Ov6aJrzzN37AA6RUUQRERERFQTpNQ5jXWXNOMzSwClDTGo6SA2JR6m6ahWyFegDAAAAAAAAAOH1BQAAAAAA"
    }
}' | jq .

# Sign transaction
iota keytool sign --address 0x111111111504e9350e635d65cd38ccd2c029434c6a3a480d8947a9ba6a15b215 --data AAADAAhkAAAAAAAAAAAIyAAAAAAAAAAAIBEREREVBOk1DmNdZc04zNLAKUNMajpIDYlHqbpqFbIVAgIAAgEAAAEBAAECAwAAAAADAAABAAECABEREREVBOk1DmNdZc04zNLAKUNMajpIDYlHqbpqFbIVAQAxz0TZtWjb2TMC0j+gZLE7QuDD90F4MilwL4VYTR7gR9SxDAAAAAAgzFKhcPCs0Q1NZdxjuD9IQkOw7Ov6aJrzzN37AA6RUUQRERERFQTpNQ5jXWXNOMzSwClDTGo6SA2JR6m6ahWyFegDAAAAAAAAAOH1BQAAAAAA

# Execute transaction
curl https://api.testnet.iota.cafe \
--header 'content-type: application/json' \
--data '{
    "jsonrpc": "2.0",
    "id": 1,
    "method": "iota_executeTransactionBlock",
    "params": {
        "tx_bytes": "AAADAAhkAAAAAAAAAAAIyAAAAAAAAAAAIBEREREVBOk1DmNdZc04zNLAKUNMajpIDYlHqbpqFbIVAgIAAgEAAAEBAAECAwAAAAADAAABAAECABEREREVBOk1DmNdZc04zNLAKUNMajpIDYlHqbpqFbIVAQAxz0TZtWjb2TMC0j+gZLE7QuDD90F4MilwL4VYTR7gR9SxDAAAAAAgzFKhcPCs0Q1NZdxjuD9IQkOw7Ov6aJrzzN37AA6RUUQRERERFQTpNQ5jXWXNOMzSwClDTGo6SA2JR6m6ahWyFegDAAAAAAAAAOH1BQAAAAAA",
        "signatures": ["AP5bD1noWq2hH8ABsuWpSYIidCckBPxkHfApNKS08jvhr2cUJFO4kToefvq74ktJXhycOf7dYxBvrug/tpI5wgcoe8lptdiMUw3h3rcxQJf3bWp9zFLP4Eq3rpQOam52cw=="],
        "options": {
            "showBalanceChanges": true,
            "showEffects": true,
            "showEvents": true,
            "showInput": true,
            "showObjectChanges": true,
            "showRawEffects": false,
            "showRawInput": true
        }
    }
}' | jq .


iota client switch --env testnet
iota client faucet
sleep 2
SENDER_ADDRESS=$(iota client active-address)
read GAS_COIN COIN_TO_SPLIT < <(iota client gas --json | jq -r '[.[0].gasCoinId, .[1].gasCoinId] | @sh' | tr -d \')
AMOUNT_TO_SPLIT=1000
# just sending to own address
RECIPIENT_ADDRESS=$(iota client active-address)
GAS_BUDGET=100000000

JSON_DATA='{
  "jsonrpc": "2.0",
  "id": 1,
  "method": "unsafe_batchTransaction",
  "params": {
    "signer": "'$SENDER_ADDRESS'",
    "single_transaction_params": [
      {
        "moveCallRequestParams": {
          "packageObjectId": "0x2",
          "module": "coin",
          "function": "split",
          "typeArguments": ["0x2::iota::IOTA"],
          "arguments": ["'$COIN_TO_SPLIT'", "'$AMOUNT_TO_SPLIT'"]
        }
      },
      {
        "moveCallRequestParams": {
          "packageObjectId": "0x2",
          "module": "transfer",
          "function": "public_transfer",
          "typeArguments": ["0x2::coin::Coin<0x2::iota::IOTA>"],
          "arguments": [{"Result": 0}, "'$RECIPIENT_ADDRESS'"]
        }
      }
    ],
    "gas": "'$GAS_COIN'",
    "gas_budget": "'$GAS_BUDGET'"
  }
}'

echo "$JSON_DATA"

curl https://api.testnet.iota.cafe \
--header 'content-type: application/json' \
--data "$JSON_DATA" | jq .


TIMELOCKED_IOTA=0x00020a50ce34ec50e35fae9854b25a12655d9d699558021ab7f01eb4d82dacd8
SENDER_ADDRESS=0x24adc8c88f491956b3db3aa7814122b5c35249c512be41e0cf5d1cc22de73c9f
GAS_COIN=0x2b9bf0e33071124a5d87c769c48e3470c4c8ce2df9d32dbe4991051681d7db52
GAS_BUDGET=100000000

JSON_DATA='{
  "jsonrpc": "2.0",
  "id": 1,
  "method": "unsafe_batchTransaction",
  "params": {
    "signer": "'$SENDER_ADDRESS'",
    "single_transaction_params": [
      {
        "moveCallRequestParams": {
          "packageObjectId": "0x2",
          "module": "timelock",
          "function": "unlock",
          "typeArguments": ["0x2::balance::Balance<0x2::iota::IOTA>"],
          "arguments": ["'$TIMELOCKED_IOTA'"]
        }
      },
      {
        "moveCallRequestParams": {
          "packageObjectId": "0x2",
          "module": "coin",
          "function": "from_balance",
          "typeArguments": ["0x2::iota::IOTA"],
          "arguments": [{"Result": 0}]
        }
      },
      {
        "moveCallRequestParams": {
          "packageObjectId": "0x2",
          "module": "transfer",
          "function": "transfer",
          "typeArguments": ["0x2::iota::IOTA"],
          "arguments": [{"Result": 1}, "'$SENDER_ADDRESS'"]
        }
      }
    ],
    "gas": "'$GAS_COIN'",
    "gas_budget": "'$GAS_BUDGET'"
  }
}'

curl https://api.devnet.iota.cafe \
--header 'content-type: application/json' \
--data "$JSON_DATA" | jq .
